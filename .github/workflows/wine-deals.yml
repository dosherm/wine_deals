name: Wine Deal Scanner

on:
  schedule:
    - cron: "0,30 0-2,13-23 * * *"  # every 30 min, 7am-8pm Central (UTC-6; shifts 1hr during daylight saving)
  workflow_dispatch:           # allows manual trigger from GitHub UI

permissions:
  contents: write

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Restore notification cache
        uses: actions/cache@v4
        with:
          path: notified.json
          key: notified-${{ github.run_id }}
          restore-keys: notified-

      - name: Install dependencies
        run: pip install requests beautifulsoup4

      - name: Run wine deal scraper
        env:
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
        run: python scraper.py

      - name: Upload run log via API
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get current file SHA (if it exists) for the update
          SHA=$(gh api repos/${{ github.repository }}/contents/last_run.txt --jq '.sha' 2>/dev/null || echo "")
          CONTENT=$(base64 -w 0 last_run.txt)
          if [ -n "$SHA" ]; then
            gh api repos/${{ github.repository }}/contents/last_run.txt \
              -X PUT \
              -f message="update last_run.txt" \
              -f content="$CONTENT" \
              -f sha="$SHA" \
              --silent
          else
            gh api repos/${{ github.repository }}/contents/last_run.txt \
              -X PUT \
              -f message="update last_run.txt" \
              -f content="$CONTENT" \
              --silent
          fi
          echo "last_run.txt updated via API"
